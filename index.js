(function(){var t;t=angular.module("0media.events",[]),t.controller("0media.events.main",["$scope","$interval","$timeout","$http","0media.events.map","0media.events.map-style"].concat(function(t,e,n,a,r,s){var i,o,u;return t.style="default",i=$("#zm-event .eventmap"),t.dim={width:0,height:0,wtype:"w-md",htype:"h-md",timelineHeight:300},o=function(){return t.$apply(function(){var e,n,a;return e=[i.width(),i.height()],n=e[0],a=e[1],e=t.dim,e.width=n,e.height=a,t.dim.wtype=480>=n?"w-mc":768>=n?"w-xs":991>=n?"w-sm":1199>=n?"w-md":"w-lg",t.dim.htype=240>=a?"h-mc":320>=a?"h-xs":480>=a?"h-sm":600>=a?"h-md":"h-lg",t.dim.timelineHeight={"h-mc":120,"h-xs":140,"h-sm":200,"h-md":300,"h-lg":300}[t.dim.htype]})},u={onAdd:function(t,e){var n;return n=$("#zm-event .bubbles")[0],n.parentNode.removeChild(n),e.appendChild(n)},draw:function(e,n){var a;return a=Math.pow(2,n.getZoom()-6),console.log(a),t.events.map(function(t){var n;return t.x=(n=e.ll2p(t.lat,t.lng)).x,t.y=n.y,t.rate=a})}},t.reset=function(e){return null==e&&(e=!1),t.events.top=5,t.stepCount=0,t.events.map(function(t,n){return t.fadeout=1,t.opacity=.8,t.size=0,t.circle_opacity=0,t.bubble={},t.first=!1,e||(t.top=50*n),t})},t.setStyle=function(e){return t.style=e,t.map.set("styles",s[e])},t.play=function(){return t.state=1,t.dir=1},t.pause=function(){return t.state=0},t.speeding=function(){return t.speed=t.speed%3+1},t.step=function(e){return e!==t.dir&&t.events.map(function(t){return t.bubble={state:0},t.size=0,t.circle_opacity=0,t}),t.dir=e,t.state=2},t.state=1,t.speed=3,t.dir=1,t.loaded="loading",t.initData=function(){var e;return e={src:"1p0DNKBt4oNfDBgHv4ZXH-vu0bJ_PtxFFXCL7o4O_Cxo",color:"default",ratio:1},((window.location.search||"").split("?").filter(function(t){return t})[0]||"").split("&").map(function(t){var n;return n=t.split("="),e[n[0]]=n[1]}),a({url:"https://spreadsheets.google.com/feeds/list/"+e.src+"/1/public/values?alt=json",method:"GET"}).success(function(a){var s,l,p,c,d;return console.log(a),s=a.feed.entry.map(function(t){var e,n,a,r,s,i,o,u,l;return e=t.gsx$date.$t.replace(/[年月]/g,"/"),e=e.replace(/[日]/g,""),n=new Date(e),a=n.getMonth()+1,e=n.getYear()+1900+"/"+(10>a?"0":"")+a,r={die:parseInt(t.gsx$death.$t),hurt:parseInt(t.gsx$wounded.$t)},r.total=r.die+r.hurt,r.radius=3*parseInt(Math.sqrt(r.total))+10,s=parseFloat(t.gsx$latitude.$t||0),i=parseFloat(t.gsx$longitude.$t||0),o=(t.gsx$shortname.$t||t.gsx$event.$t).trim(),u=new google.maps.LatLng(s,i),l={name:o,dateFull:n,casualty:r,lat:s,lng:i,loc:u,date:e}}),s=s.filter(function(t){return t.lat&&t.lng&&t.casualty.total}),l=s.map(function(t){return t.lat}).sort(),p=s.map(function(t){return t.lng}).sort(),c=function(){var e,a,r,i,o;return e=0,a=!1,r=t.dim.timelineHeight,r=.9*$("#zm-event .timeline .line").height(),i=r/3,o=1.33*r,(s[s.length-1].top<=67&&1===t.dir||s[0].top>=65&&-1===t.dir)&&(t.state=0),s.map(function(n){var s,u;return 1===t.state&&(n.top=n.top-4*t.dir),n.top<=67&&n.top>=64&&(e=1),n.top<65&&(n.fadeout=1-(65-n.top)/20,n.fadeout<0&&(n.fadeout=0)),n.top>r&&(n.fadeout=1-(n.top-r)/i),n.opacity=(o-n.top)/o,(s=(u=n.opacity)<1?u:1)>0?s:0,(n.top<-200||n.top>r)&&(n.bubble.state=0,n.circle_opacity=0,n.size=0),1===n.bubble.state&&(n.bubble.state=2,n.circle_opacity=0,n.size=n.casualty.radius*n.rate),!a&&n.top>=64&&(t.current=n,n.first=!0,2!==n.bubble.state&&(n.bubble.state=1,n.circle_opacity=1,n.size=0),a=!0),n}),e?n(step,910-300*t.speed):n(step,40-10*t.speed)},t.stepCount=0,d=function(){var a,r,i,o;return t.state&&(a=s[t.stepCount+t.dir],a&&(a.circle_opacity=1,a.bubble.state=1,a.size=a.casualty.radius*a.rate*e.ratio),a&&(t.current=a),r=s[t.stepCount],r&&(r.bubble.state=2),i=s[t.stepCount-t.dir],i&&(i.circle_opacity=0),t.events.top=(t.events.top||5)-50*t.dir,t.events.top>5&&(t.events.top=5,t.state=0),t.events.top<5-50*(t.events.length-1)&&(t.events.top=5-50*(t.events.length-1),t.state=0),t.stepCount+=t.dir,t.stepCount>=0||(t.stepCount=0),t.stepCount<=(o=t.events.length-1)||(t.stepCount=o)),2===t.state&&(t.state=0),n(d,[1600,800,300][t.speed-1])},n(d,0),t.events=s,t.reset(),t.map=r.init(i[0],[l[0],l[l.length-1]],[p[0],p[p.length-1]],o,u),t.setStyle(e.color),t.loaded="",setTimeout(o,0)})},t.initData()}))}).call(this);(function(){var t;t=angular.module("main",["0media.events"]),t.controller("main",["$scope","$timeout"].concat(function(t,e){var r;return r="http://zbryikt.github.io/geoevent",t.setStyle=function(e){return t.style=e},t.setRatio=function(e){return t.ratio=e},t.updateWidget=function(){return e(function(){var e;return e=/\/d\/([^\/]+)/.exec(t.datasrc),e&&t.style&&t.ratio?(t.outurl="/widget/?src="+e[1]+"&color="+t.style+"&ratio="+t.ratio,t.outurlwithhost=r+t.outurl,t.embedcode="<iframe src='"+r+t.outurl+"'></iframe>"):void 0},1e3)},t.$watch("datasrc",t.updateWidget),t.$watch("style",t.updateWidget),t.$watch("ratio",t.updateWidget)}))}).call(this);(function(){var e;e=angular.module("0media.events"),e.factory("0media.events.map-style",[].concat(function(){return{green:[{featureType:"water",stylers:[{color:"#18bca8"},{saturation:-35},{lightness:68}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#18bc9c"},{saturation:-36},{lightness:10}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#18bc9c"},{lightness:65},{saturation:-22}]},{}],gray:[{featureType:"water",stylers:[{color:"#dddddd"}]},{featureType:"landscape",stylers:[{color:"#bbbbbb"}]},{featureType:"road",stylers:[{color:"#999999"},{weight:.4},{visibility:"simplified"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{color:"#aaaaaa"}]},{featureType:"administrative",elementType:"geometry",stylers:[{visibility:"on"},{weight:1.3},{color:"#444444"}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#222222"}]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{}],"default":[{featureType:"water",stylers:[{hue:"#1900ff"},{lightness:-86},{saturation:-80}]},{featureType:"landscape",stylers:[{lightness:-47},{hue:"#dd3d00"},{saturation:-80}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:-30}]},{featureType:"road",stylers:[{weight:.3},{saturation:-48},{lightness:-0},{hue:"#dd4400"}]}]}}))}).call(this);(function(){function n(n,o){var t={}.hasOwnProperty;for(var e in o)t.call(o,e)&&(n[e]=o[e]);return n}var o;o=angular.module("0media.events"),o.factory("0media.events.map",[].concat(function(){return{init:function(o,t,e,a,r){var i,g,s,l,u,m;return i={center:new google.maps.LatLng(23.624146,120.320623),zoom:9,minZoom:2,maxZoom:18,mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:!1,scaleControl:!1,mapTypeControl:!1,streetViewControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}},g=new google.maps.LatLngBounds,s=[[t[1],e[0]],[t[0],e[1]]],s.map(function(n){return new google.maps.LatLng(n[0],n[1])}).map(function(n){return g.extend(n)}),l=function(n){return n.getYear()+1900},u=new google.maps.Map(o,i),u.fitBounds(g),google.maps.event.addDomListener(window,"resize",function(){var n,t,e,r,i,s,l,m;return n=[$(o).width(),$(o).height()],t=n[0],e=n[1],u.fitBounds(g),r=u.getBounds(),n=[r.getNorthEast().lat(),r.getSouthWest().lng()],i=n[0],s=n[1],n=[r.getSouthWest().lat(),r.getNorthEast().lng()],l=n[0],m=n[1],a([i,m],[l,s])}),m=n(new google.maps.OverlayView,{ll2p:function(n,o){var t,e;return t=this.getProjection(),e=t.fromLatLngToDivPixel(new google.maps.LatLng(n,o))},onAdd:function(){return r.onAdd(this,this.getPanes().overlayLayer)},draw:function(){return r.draw(this,u)}}),m.setMap(u),u}}}))}).call(this);